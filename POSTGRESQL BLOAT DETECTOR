

-- QUERY 1: Find tables with high dead tuple percentage
-- If dead_pct > 20%, you have bloat problems
SELECT
    schemaname || '.' || relname as table_name,
    n_live_tup as live_rows,
    n_dead_tup as dead_rows,
    ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) as dead_pct,
    last_autovacuum::date as last_autovacuum
FROM pg_stat_user_tables
WHERE n_dead_tup > 10000
ORDER BY n_dead_tup DESC
LIMIT 10;

-- QUERY 2: Tables that have never been vacuumed
SELECT
    schemaname || '.' || relname as table_name,
    n_dead_tup as dead_rows,
    'VACUUM ANALYZE ' || schemaname || '.' || relname || ';' as fix
FROM pg_stat_user_tables
WHERE last_vacuum IS NULL 
  AND last_autovacuum IS NULL
  AND n_live_tup > 1000
LIMIT 5;

- ============================================================================
-- ðŸš€ WANT THE COMPLETE TOOLKIT?
-- ============================================================================
--
-- This is 1 query from a 1,000+ line diagnostic script that checks:
--
-- âœ… Slow queries (with percentage breakdown)
-- âœ… Missing indexes (JSONB, Foreign Keys, Sequential Scans)
-- âœ… Unused indexes (wasting write performance)
-- âœ… Duplicate indexes (wasting disk space)
-- âœ… Table bloat (dead tuples)
-- âœ… Lock contention (who's blocking whom)
-- âœ… Cache hit ratio (disk vs. memory)
-- âœ… Replication lag
-- âœ… Connection leaks
-- âœ… Transaction ID wraparound risk
-- âœ… Autovacuum health
-- âœ… And 30+ more production checks
--
-- ðŸ‘‰ Get The Complete PostgreSQL Sev-1 Toolkit ($29)
--    https://haiderdba.gumroad.com/l/ccget
--
-- ðŸ“¬ Subscribe to The Sev-1 Database Newsletter (FREE)
--    https://haiderzdbre.substack.com/subscribe
--
-- ============================================================================
