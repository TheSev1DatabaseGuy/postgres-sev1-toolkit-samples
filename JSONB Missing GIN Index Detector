JSONB Missing GIN Index Detector
-- ============================================================================
-- 
-- FROM: The PostgreSQL Sev-1 Toolkit
-- AUTHOR: Haider Z (The Sev-1 Database Newsletter)
-- 
-- PROBLEM: Using JSONB without GIN indexes = Full table scans on every query
-- 
-- This query detects JSONB columns that are missing GIN indexesâ€”one of the
-- most common performance bottlenecks when migrating from MongoDB to PostgreSQL.
--
-- âš ï¸ If this returns results, you're scanning entire tables for JSON queries.
-- 
-- ============================================================================

-- JSONB Columns Missing GIN Indexes (The "MongoDB Trap")

SELECT 
    'ðŸ”´ JSONB MISSING GIN INDEX' as alert_type,
    n.nspname || '.' || c.relname as table_name,
    a.attname as jsonb_column,
    pg_size_pretty(pg_relation_size(c.oid)) as table_size,
    'CREATE INDEX CONCURRENTLY ON ' || n.nspname || '.' || c.relname 
        || ' USING gin (' || a.attname || ' jsonb_path_ops);' as fix_command
FROM pg_attribute a
JOIN pg_class c ON a.attrelid = c.oid
JOIN pg_namespace n ON c.relnamespace = n.oid
WHERE a.atttypid = 'jsonb'::regtype
  AND c.relkind = 'r'
  AND n.nspname NOT IN ('pg_catalog', 'information_schema')
  AND NOT EXISTS (
    SELECT 1 FROM pg_index i
    JOIN pg_class ic ON ic.oid = i.indexrelid
    JOIN pg_am am ON am.oid = ic.relam
    WHERE i.indrelid = c.oid
      AND a.attnum = ANY(i.indkey)
      AND am.amname = 'gin'
);

-- ============================================================================
-- ðŸ“Š WHAT THE OUTPUT MEANS
-- ============================================================================
--
-- If this returns rows:
-- âœ… table_name = The table with unindexed JSONB
-- âœ… jsonb_column = The column that needs an index
-- âœ… table_size = How big the table is (larger = worse performance)
-- âœ… fix_command = Copy-paste this to fix it
--
-- If this returns NO rows:
-- âœ… Congratulations! All your JSONB columns are properly indexed.
--
-- ============================================================================
-- ðŸ’¡ WHY THIS MATTERS
-- ============================================================================
--
-- Without a GIN index, queries like:
--   SELECT * FROM users WHERE data @> '{"status": "active"}';
--
-- Will scan THE ENTIRE TABLE row-by-row.
--
-- With a GIN index, PostgreSQL can jump directly to matching rows.
--
-- Performance difference: 100x - 1000x faster.
--
-- ============================================================================
-- ðŸš€ WANT THE COMPLETE TOOLKIT?
-- ============================================================================
--
-- This is 1 query from a 1,000+ line diagnostic script that checks:
--
-- âœ… Slow queries (with percentage breakdown)
-- âœ… Missing indexes (JSONB, Foreign Keys, Sequential Scans)
-- âœ… Unused indexes (wasting write performance)
-- âœ… Duplicate indexes (wasting disk space)
-- âœ… Table bloat (dead tuples)
-- âœ… Lock contention (who's blocking whom)
-- âœ… Cache hit ratio (disk vs. memory)
-- âœ… Replication lag
-- âœ… Connection leaks
-- âœ… Transaction ID wraparound risk
-- âœ… Autovacuum health
-- âœ… And 30+ more production checks
--
-- ðŸ‘‰ Get The Complete PostgreSQL Sev-1 Toolkit ($29)
--    https://haiderdba.gumroad.com/l/ccget
--
-- ðŸ“¬ Subscribe to The Sev-1 Database Newsletter (FREE)
--    https://haiderzdbre.substack.com/subscribe
--
-- ============================================================================
